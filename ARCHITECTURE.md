# Архитектура

## Техническая архитектура

Система CodeCraft Academy представляет собой сеть взаимодействующих узлов, каждый из которых является отдельным сервером (реальным или виртуальным).

**Типы узлов:**

*   **Изначальный узел (Initial):**
    *   Центральный узел сети.
    *   Хранит реестр узлов и пользователей.
    *   Предоставляет общую библиотеку сущностей.
    *   Обеспечивает маршрутизацию сообщений между узлами (может проксировать запросы).
    *   Может выполнять функции узла-прокси.
    *   Поддерживает работу "общих пространств" для новичков.
*   **Доверенный узел (Trusted):**
    *   Полноценный узел сети.
    *   Может выступать в роли прокси-сервера для Локальных узлов.
    *   Может предоставлять вычислительные ресурсы другим пользователям (майнинг, аренда).
    *   Хранит данные и выполняет код аватаров-агентов, "живущих" на нем.
*   **Локальный узел (Local):**
    *   Работает на локальной машине пользователя (разработчика).
    *   Подключается к сети через узел-прокси (Изначальный или Доверенный).
    *   Предоставляет среду для разработки и тестирования аватаров-агентов в режиме "локальной песочницы".
    *   Может отправлять статистику на Доверенный узел.
*   **Узел-прокси:**
    *   Обеспечивает доступ к сети для Локальных узлов, не имеющих статического IP-адреса.
    *   Выполняет туннелирование трафика между Локальным узлом и сетью.

**Взаимодействие узлов:**

*   **Регистрация:**  При запуске узлы регистрируются на Изначальном узле, передавая свои данные (IP-адрес, порт, тип, имя, публичный ключ).
*   **Обмен сообщениями:**  Узлы могут обмениваться сообщениями друг с другом через Изначальный узел или напрямую (если настроено).
*   **Передача данных:**  Узлы могут передавать друг другу данные (например, при перемещении аватара-агента).
*   **Проксирование:**  Изначальный или Доверенный узел может выступать в роли прокси для Локальных узлов, не имеющих статического IP.
*   **Аутентификация:**  Взаимодействие между узлами должно быть защищено с помощью аутентификации (например, с использованием ключей SSH или токенов).

**Протоколы взаимодействия:**

*   **Регистрация узлов, получение списка узлов, общие запросы:**  REST API (Flask) через HTTPS.
*   **Взаимодействие между аватарами-агентами:**  [Заглушка:  Предположительно, WebSocket или REST API]
*   **Туннелирование трафика (прокси):**  SSH-туннелирование.
*   **Передача файлов (перемещение аватара):**  [Заглушка:  Предположительно, SCP, SFTP или REST API]

**Форматы данных:**

*   **JSON:**  Используется для передачи данных между узлами и аватарами-агентами.
*   **SQLite:**  Используется для хранения данных на узлах.

**Разделение вычислений:**

*   **Клиент (браузер):**
    *   Рендеринг интерфейса.
    *   Обработка пользовательского ввода.
    *   Взаимодействие с сервером через WebSocket (эмулятор терминала) или AJAX (REST API).
*   **Сервер (узел):**
    *   **Общий сервер (Изначальный, Доверенный):**
        *   Управление состоянием сети (реестр узлов, пользователей).
        *   Маршрутизация сообщений.
        *   Хранение общих данных (библиотека сущностей, глобальные данные мира).
        *   Поддержка работы "общих пространств".
        *   Обработка запросов от клиентов и других узлов.
        *   Взаимодействие с блокчейном (опционально).
        *   Модерация.
    *   **Локальный сервер:**
        *   Выполнение кода аватаров-агентов.
        *   Взаимодействие с другими узлами.
        *   Хранение данных, специфичных для узла.
        *   Поддержка режима "локальной песочницы".

## Схема сети

[Заглушка:  Добавить схему сети с указанием узлов, связей и потоков данных]

## Структура узла

```
node/
├── app.py # Основной код приложения Flask
├── data.db # База данных SQLite
├── config.json # Файл конфигурации узла
├── entities/ # Директория для хранения сущностей
│ └── developers/ # Директория для разработчиков
│ └── developer1/ # Директория разработчика developer1
│ ├── location/
│ │ └── location1.json
│ ├── npc/
│ │ └── npc1.json
│ └── item/
│ └── item1.json
│ └── developer2/ # Директория разработчика developer2
│ ├── location/
│ │ └── my_new_location.json
│ └── ...
│ └── shared/ # Общая директория (опционально)
│ └── location/
│ └── npc/
│ └── item/
├── static/ # Статические файлы (HTML, CSS, JavaScript)
│ └── index.html
├── utils/ # Вспомогательные скрипты
│ └── manage_users.py # Скрипт управления пользователями
└── ...
```

## Схема базы данных

**Таблица `users`:**

| Поле          | Тип       | Описание                                      |
| :------------ | :-------- | :-------------------------------------------- |
| id            | INTEGER   | Первичный ключ, автоинкремент                 |
| username      | TEXT      | Уникальное имя пользователя (логин)           |
| password_hash | TEXT      | Хеш пароля пользователя                       |
| role          | TEXT      | Роль пользователя ("player", "developer", "admin") |

**Таблица `nodes`:**

| Поле       | Тип       | Описание                                                     |
| :--------- | :-------- | :----------------------------------------------------------- |
| id         | INTEGER   | Первичный ключ, автоинкремент                                  |
| node_id    | TEXT      | Уникальный идентификатор узла                               |
| node_name  | TEXT      | Имя узла                                                    |
| node_type  | TEXT      | Тип узла ("initial", "trusted", "local", "proxy")         |
| ip_address | TEXT      | IP-адрес узла                                                |
| port       | INTEGER   | Порт узла                                                     |
| last_seen  | TIMESTAMP | Время последней активности узла                             |
| owner      | TEXT      | Владелец узла (username)                                     |
| public_key | TEXT      | Публичный ключ узла (для аутентификации)                      |

**Таблица `entities`:**

| Поле        | Тип    | Описание                                                      |
| :---------- | :----- | :------------------------------------------------------------ |
| id          | INTEGER | Первичный ключ, автоинкремент                                  |
| entity_type | TEXT   | Тип сущности ("location", "npc", "item", "avatar")              |
| entity_id   | TEXT   | Уникальный идентификатор сущности                             |
| owner       | TEXT   | Владелец сущности (username разработчика или "system")          |
| data        | TEXT   | JSON-строка с данными сущности (описание, характеристики и т.д.) |
| node_id     | TEXT   | ID узла, на котором находится сущность                        |

**Таблица `resource_usage`:**

| Поле             | Тип       | Описание                                                         |
| :--------------- | :-------- | :--------------------------------------------------------------- |
| id               | INTEGER   | Первичный ключ, автоинкремент                                    |
| timestamp        | TIMESTAMP | Время записи                                                      |
| username         | TEXT      | Имя пользователя (разработчика), запустившего процесс             |
| node_id          | TEXT      | ID узла, на котором запущен процесс                               |
| process_pid      | INTEGER   | PID процесса                                                    |
| cpu_percent      | REAL      | Процент загрузки CPU                                              |
| memory_usage     | REAL      | Использование оперативной памяти (в МБ)                           |
| network_sent     | INTEGER   | Количество отправленных байт                                        |
| network_received | INTEGER   | Количество принятых байт                                          |
| disk_read        | INTEGER   | Количество прочитанных байт с диска                               |
| disk_write       | INTEGER   | Количество записанных байт на диск                                |

**Таблица `stats`:**

| Поле        | Тип    | Описание                                                      |
| :---------- | :----- | :------------------------------------------------------------ |
| id          | INTEGER | Первичный ключ, автоинкремент                                  |
| timestamp   | TIMESTAMP | Время записи                                                      |
| node_id     | TEXT   | ID узла, с которого поступила статистика                        |
| data        | TEXT   | JSON-строка с данными                                            |

**Таблицы для цепей и сетей:**

[Заглушка:  Нужно проработать структуру таблиц]

## API

[Заглушка:  Нужно проработать и описать API]

**Продолжение следует...**
